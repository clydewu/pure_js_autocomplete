<html>
<head>
    <title>Pre-test</title>
</head>
<body>
<link rel="stylesheet" type="text/css" href="./cld.css" />
<link rel="stylesheet" href="./qunit-1.14.0.css">
<script src="./qunit-1.14.0.js"></script>
<script src="./tz.json"></script>
<script src="./cld.js"></script>
<script>
var init = function(){
    var conf = {
        key: "city",
        dataObj: tz,
        submitCallback: {
            lock:   function () { document.getElementById("Submit").disabled = true;  },
            unLock: function () { document.getElementById("Submit").disabled = false; },
        },
    }
    var ctl1, ctl2; 

    QUnit.module( "AutoComplete", {
        setup: function( assert ) {
            ctl1 = CLD.AutoComplete(document.getElementById("PRE_TEST"), conf);
        }, teardown: function( assert ) {
            ctl1.destroyer();
            document.getElementById("PRE_TEST").value = "";
        }
    });

    QUnit.test("Widget method: query(), normal operation", function (assert){
        expect(6);
        stop();
        ctl1.query("A");
        setTimeout(function() {
            assert.equal(document.getElementsByClassName("CLD_AC_PromptItem HightLight").length, 1);
            assert.equal(document.getElementsByClassName("CLD_AC_PromptItem HightLight")[0].innerHTML, "Abidjan");
            start();
            ctl1.query("Ar");
        }, 500);

        stop();
        setTimeout(function() {
            assert.equal(document.getElementsByClassName("CLD_AC_PromptItem HightLight").length, 1);
            assert.equal(document.getElementsByClassName("CLD_AC_PromptItem HightLight")[0].innerHTML, "Araguaina");
            start();
            ctl1.query("Arg");
        }, 1000);

        stop();
        setTimeout(function() {
            assert.equal(document.getElementsByClassName("CLD_AC_PromptItem HightLight").length, 1);
            assert.equal(document.getElementsByClassName("CLD_AC_PromptItem HightLight")[0].innerHTML, "Argentina/Buenos_Aires");
            start();
        }, 1500);
    });

    QUnit.test("Widget method: query(), clear current input", function (assert){
        expect(5);
        stop();
        ctl1.query("A");
        setTimeout(function() {
            assert.equal(document.getElementsByClassName("CLD_AC_PromptItem HightLight").length, 1);
            assert.equal(document.getElementsByClassName("CLD_AC_PromptItem HightLight")[0].innerHTML, "Abidjan");
            assert.equal(document.getElementById("Submit").disabled, true);
            start();
        }, 500);

        stop();
        setTimeout(function() {
            ctl1.query("");
        }, 1000);

        setTimeout(function() {
            assert.equal(document.getElementsByClassName("CLD_AC_PromptBox")[0].style.display, "none");
            assert.equal(document.getElementById("Submit").disabled, false);
            start();
        }, 1500);

    });

    QUnit.test("Widget method: query(), new query after existen query", function (assert){
        expect(5);
        stop();
        ctl1.query("Arg");
        setTimeout(function() {
            assert.equal(document.getElementsByClassName("CLD_AC_PromptItem HightLight").length, 1);
            assert.equal(document.getElementsByClassName("CLD_AC_PromptItem HightLight")[0].innerHTML, "Argentina/Buenos_Aires");
            assert.equal(document.getElementById("Submit").disabled, true);
            start();
        }, 500);

        stop();
        setTimeout(function() {
            ctl1.query("B");
        }, 1000);

        setTimeout(function() {
            assert.equal(document.getElementsByClassName("CLD_AC_PromptItem HightLight").length, 1);
            assert.equal(document.getElementsByClassName("CLD_AC_PromptItem HightLight")[0].innerHTML, "Baghdad");
            start();
        }, 1500);

    });

    QUnit.test("Widgt method: moveItem, positive num", function (assert){
        expect(3);
        ctl1.query("A");

        stop();
        setTimeout(function() {
            assert.ok(document.getElementsByClassName("CLD_AC_PromptItem")[0].className.indexOf("HightLight") >= 0);
            start();
            ctl1.moveItem(1);
        }, 500);

        stop();
        setTimeout(function() {
            assert.ok(document.getElementsByClassName("CLD_AC_PromptItem")[0].className.indexOf("HightLight") < 0);
            assert.ok(document.getElementsByClassName("CLD_AC_PromptItem")[1].className.indexOf("HightLight") >= 0);
            start();
        }, 1000);

    });

    QUnit.test("Widgt method: moveItem(), positive num and overflow", function (assert){
        expect(3);
        ctl1.query("A");

        stop();
        setTimeout(function() {
            assert.ok(document.getElementsByClassName("CLD_AC_PromptItem")[0].className.indexOf("HightLight") >= 0);
            start();
            ctl1.moveItem(document.getElementsByClassName("CLD_AC_PromptItem").length - 1);
        }, 500);

        stop();
        setTimeout(function() {
            assert.ok(document.getElementsByClassName("CLD_AC_PromptItem")[0].className.indexOf("HightLight") < 0);
            assert.ok(document.getElementsByClassName("CLD_AC_PromptItem")[document.getElementsByClassName("CLD_AC_PromptItem").length - 1].className.indexOf("HightLight") >= 0);
            start();
        }, 1000);

    });
        
    QUnit.test("Widgt method: moveItem(), negative num and overflow", function (assert){
        expect(3);
        ctl1.query("A");

        stop();
        setTimeout(function() {
            assert.ok(document.getElementsByClassName("CLD_AC_PromptItem")[0].className.indexOf("HightLight") >= 0);
            start();
            ctl1.moveItem(-2);
        }, 500);

        stop();
        setTimeout(function() {
            assert.ok(document.getElementsByClassName("CLD_AC_PromptItem")[0].className.indexOf("HightLight") < 0);
            assert.ok(document.getElementsByClassName("CLD_AC_PromptItem")[document.getElementsByClassName("CLD_AC_PromptItem").length - 2].className.indexOf("HightLight") >= 0);
            start();
        }, 1000);
    });

    QUnit.test("Widgt method: moveItem(), number over length", function (assert){
        expect(3);
        ctl1.query("A");

        stop();
        setTimeout(function() {
            assert.ok(document.getElementsByClassName("CLD_AC_PromptItem")[0].className.indexOf("HightLight") >= 0);
            start();
            ctl1.moveItem(document.getElementsByClassName("CLD_AC_PromptItem").length * 2 + 2);
        }, 500);

        stop();
        setTimeout(function() {
            assert.ok(document.getElementsByClassName("CLD_AC_PromptItem")[0].className.indexOf("HightLight") < 0);
            assert.ok(document.getElementsByClassName("CLD_AC_PromptItem")[2].className.indexOf("HightLight") >= 0);
            start();
        }, 1000);
    });

    QUnit.test("Widget method: checkItem(), check twice", function (assert){
        expect(3);
        ctl1.query("A");

        stop();
        setTimeout(function() {
            ctl1.checkItem(ctl1.getSelectedIndex());
            ctl1.query("B");
        }, 1000);

        setTimeout(function() {
            ctl1.checkItem(ctl1.getSelectedIndex());
        }, 2000);

        setTimeout(function() {
            assert.equal(document.getElementsByClassName("CLD_AC_Checked").length, 2);
            assert.equal(document.getElementsByClassName("CLD_AC_Checked")[0].childNodes[0].data, "Abidjan");
            assert.equal(document.getElementsByClassName("CLD_AC_Checked")[1].childNodes[0].data, "Baghdad");
            start();
        }, 3000);
    });

    QUnit.test("Widget method: checkItem(), check non-existen item", function (assert){
        expect(1);
        ctl1.query("A");

        stop();
        setTimeout(function() {
            try {
                ctl1.checkItem(1000);
            } catch (exp) {
                assert.equal(exp.message, "node is undefined");
            }
            start();
        }, 500);
    });

    QUnit.test("Widget method: unCheckItem(), checked two items and uncheck first one twice", function (assert){
        expect(4);
        ctl1.query("A");

        stop();
        setTimeout(function() {
            ctl1.checkItem(ctl1.getSelectedIndex());
            ctl1.query("B");
        }, 500);

        setTimeout(function() {
            ctl1.checkItem(ctl1.getSelectedIndex());
        }, 1000);

        setTimeout(function() {
            assert.equal(document.getElementsByClassName("CLD_AC_Checked").length, 2);
            start();
        }, 1500);

        stop();
        setTimeout(function() {
            ctl1.unCheckItem(0);
        }, 2000);
        setTimeout(function() {
            assert.equal(document.getElementsByClassName("CLD_AC_Checked").length, 1);
            assert.equal(document.getElementsByClassName("CLD_AC_Checked")[0].childNodes[0].data, "Baghdad");
            start();
        }, 2500);

        stop();
        setTimeout(function() {
            ctl1.unCheckItem(0);
        }, 3000);
        setTimeout(function() {
            assert.equal(document.getElementsByClassName("CLD_AC_Checked").length, 0);
            start();
        }, 3500);
    });


    QUnit.test("Widget method: unCheckItem(), checked two items and uncheck 1st then 2nd", function (assert){
        expect(6);
        ctl1.query("A");

        stop();
        setTimeout(function() {
            ctl1.checkItem(ctl1.getSelectedIndex());
            ctl1.query("B");
        }, 500);

        setTimeout(function() {
            ctl1.checkItem(ctl1.getSelectedIndex());
        }, 1000);

        setTimeout(function() {
            assert.equal(document.getElementsByClassName("CLD_AC_Checked").length, 2);
            start();
        }, 1500);

        stop();
        setTimeout(function() {
            ctl1.unCheckItem(0);
        }, 2000);
        setTimeout(function() {
            assert.equal(document.getElementsByClassName("CLD_AC_Checked").length, 1);
            assert.equal(document.getElementsByClassName("CLD_AC_Checked")[0].childNodes[0].data, "Baghdad");
            start();
        }, 2500);

        stop();
        setTimeout(function() {
            try {
                ctl1.unCheckItem(1);
            } catch (exp) {
                assert.equal(exp.message, "node is undefined");
                assert.equal(document.getElementsByClassName("CLD_AC_Checked").length, 1);
                assert.equal(document.getElementsByClassName("CLD_AC_Checked")[0].childNodes[0].data, "Baghdad");
            }
            start();
        }, 2000);
    });

    QUnit.test("Widget method: getSelectedIndex()", function (assert){
        expect(2);
        ctl1.query("A");

        stop();
        setTimeout(function() {
            assert.equal(ctl1.getSelectedIndex(), 0);
            start()
        }, 500);

        stop();
        setTimeout(function() {
            ctl1.query("B");
        }, 1000);

        setTimeout(function() {
            assert.equal(ctl1.getSelectedIndex(), 43);
            start();
        }, 1500);
    });

    QUnit.test("Widget method: getCheckedItems()", function (assert){
        expect(5);
        ctl1.query("A");

        stop();
        setTimeout(function() {
            ctl1.checkItem(ctl1.getSelectedIndex());
            ctl1.query("B");
        }, 500);

        setTimeout(function() {
            ctl1.checkItem(ctl1.getSelectedIndex());
        }, 1000);

        setTimeout(function() {
            var result = ctl1.getCheckedItems();
            assert.equal(result.length, 2);
            assert.equal(result[0].city, "Abidjan");
            assert.equal(result[1].city, "Baghdad");
            start();
        }, 1500);

        stop();
        setTimeout(function() {
            ctl1.unCheckItem(0);
        }, 2000);
        setTimeout(function() {
            var result = ctl1.getCheckedItems();
            assert.equal(result.length, 1);
            assert.equal(result[0].city, "Baghdad");
            start();
        }, 2500);
    });

    QUnit.test("Widget method: getCheckedString()", function (assert){
        expect(2);
        ctl1.query("A");

        stop();
        setTimeout(function() {
            ctl1.checkItem(ctl1.getSelectedIndex());
        }, 500);

        setTimeout(function() {
            ctl1.query("B");
        }, 1000);

        setTimeout(function() {
            ctl1.checkItem(ctl1.getSelectedIndex());
        }, 1500);

        setTimeout(function() {
            assert.equal(ctl1.getCheckedString(), "Abidjan,Baghdad");
            start();
        }, 2000);

        stop();
        setTimeout(function() {
            ctl1.unCheckItem(0);
        }, 2500);
        setTimeout(function() {
            assert.equal(ctl1.getCheckedString(), "Baghdad");
            start();
        }, 3000);
    });

    QUnit.test("Widget method: reConfigure(), modify caseSensitive setup", function (assert){
        expect(2);
        ctl1.query("a");

        stop();
        setTimeout(function() {
            assert.equal(document.getElementsByClassName("CLD_AC_PromptItem HightLight").length, 1);
            start();
        }, 500);

        stop();
        setTimeout(function() {
            ctl1.reConfigure({caseSensitive: true});
            ctl1.query("a");
        }, 1500);

        setTimeout(function() {
            assert.equal(document.getElementsByClassName("CLD_AC_PromptItem HightLight").length, 0);
            start();
        }, 2000);
    });

    QUnit.test("Widget method: destroyer()", function (assert){
        expect(5);
        ctl1.destroyer();
        assert.equal(document.getElementsByClassName("CLD_AC_FrameBox").length, 0);
        assert.equal(document.getElementsByClassName("CLD_AC_CheckedBox").length, 0);
        assert.equal(document.getElementsByClassName("CLD_AC_InputBox").length, 0);
        assert.equal(document.getElementsByClassName("CLD_AC_PromptBox").length, 0);
        var ctx1 = CLD.AutoComplete(document.getElementById("PRE_TEST"), conf);
        assert.notDeepEqual(ctl1, ctx1);
        ctl1 = ctx1;
    });

    QUnit.test("Widget event: mouseup", function (assert){
        expect(4);
        ctl1.query("A");
        stop();
        setTimeout(function() {
            start();
            var event = document.createEvent("MouseEvents");
            event.initMouseEvent('mouseup', true, true, window, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                document.getElementsByClassName("CLD_AC_PromptItem")[0]);
            document.getElementsByClassName("CLD_AC_PromptItem")[0].dispatchEvent(event);
            ctl1.query("");
        }, 500);

        stop();
        setTimeout(function() {
            assert.equal(document.getElementsByClassName("CLD_AC_Checked").length, 1);
            assert.equal(document.getElementsByClassName("CLD_AC_Checked")[0].childNodes[0].data, "Abidjan");
            assert.equal(document.getElementsByClassName("CLD_AC_PromptBox")[0].style.display, "none");
            start();
            var event = document.createEvent("MouseEvents");
            event.initMouseEvent('mouseup', true, true, window, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                document.getElementsByClassName("CLD_AC_Checked")[0].childNodes[1]);
            document.getElementsByClassName("CLD_AC_Checked")[0].childNodes[1].dispatchEvent(event);
        }, 1000);

        stop();
        setTimeout(function() {
            assert.equal(document.getElementsByClassName("CLD_AC_Checked").length, 0);
            start();
        }, 1500);
    });

    QUnit.test("Widget event: keydown, up, down, and enter", function (assert){
        expect(12);
        ctl1.query("A");
        stop();
        setTimeout(function() {
            assert.equal(document.getElementsByClassName("CLD_AC_PromptItem HightLight").length, 1);
            assert.equal(document.getElementsByClassName("CLD_AC_PromptItem HightLight")[0].innerHTML, "Abidjan");
            start();
        }, 500);

        stop();
        setTimeout(function() {
            var event = document.createEvent("KeyboardEvent");
            event.initKeyEvent('keydown', true, true, null, 0, 0, 0, 0, 40, 0);
            document.getElementsByClassName("CLD_AC_InputBox")[0].dispatchEvent(event);
        }, 1000);
        setTimeout(function() {
            assert.equal(document.getElementsByClassName("CLD_AC_PromptItem HightLight").length, 1);
            assert.equal(document.getElementsByClassName("CLD_AC_PromptItem HightLight")[0].innerHTML, "Accra");
            start();
        }, 1500);

        stop();
        setTimeout(function() {
            var event = document.createEvent("KeyboardEvent");
            event.initKeyEvent('keydown', true, true, null, 0, 0, 0, 0, 38, 0);
            document.getElementsByClassName("CLD_AC_InputBox")[0].dispatchEvent(event);
        }, 2000);
        setTimeout(function() {
            assert.equal(document.getElementsByClassName("CLD_AC_PromptItem HightLight").length, 1);
            assert.equal(document.getElementsByClassName("CLD_AC_PromptItem HightLight")[0].innerHTML, "Abidjan");
            start();
        }, 2500);

        stop();
        setTimeout(function() {
            var event = document.createEvent("KeyboardEvent");
            event.initKeyEvent('keydown', true, true, null, 0, 0, 0, 0, 38, 0);
            document.getElementsByClassName("CLD_AC_InputBox")[0].dispatchEvent(event);
        }, 3000);
        setTimeout(function() {
            assert.equal(document.getElementsByClassName("CLD_AC_PromptItem HightLight").length, 1);
            assert.equal(document.getElementsByClassName("CLD_AC_PromptItem HightLight")[0].innerHTML, "Zurich");
            start();
        }, 3500);

        stop();
        setTimeout(function() {
            var event = document.createEvent("KeyboardEvent");
            event.initKeyEvent('keydown', true, true, null, 0, 0, 0, 0, 40, 0);
            document.getElementsByClassName("CLD_AC_InputBox")[0].dispatchEvent(event);
        }, 4000);
        setTimeout(function() {
            assert.equal(document.getElementsByClassName("CLD_AC_PromptItem HightLight").length, 1);
            assert.equal(document.getElementsByClassName("CLD_AC_PromptItem HightLight")[0].innerHTML, "Abidjan");
            start();
        }, 4500);

        stop();
        setTimeout(function() {
            var event = document.createEvent("KeyboardEvent");
            event.initKeyEvent('keydown', true, true, null, 0, 0, 0, 0, 13, 0);
            document.getElementsByClassName("CLD_AC_InputBox")[0].dispatchEvent(event);
        }, 5000);
        setTimeout(function() {
            assert.equal(document.getElementsByClassName("CLD_AC_Checked").length, 1);
            assert.equal(document.getElementsByClassName("CLD_AC_Checked")[0].childNodes[0].data, "Abidjan");
            start();
        }, 5500);
    });

    QUnit.module( "Multiple entries", {
        setup: function( assert ) {
            ctl1 = CLD.AutoComplete(document.getElementById("PRE_TEST"), conf);
            ctl2 = CLD.AutoComplete(document.getElementById("PRE_TEST2"), conf);
        }, teardown: function( assert ) {
            ctl1.destroyer();
            ctl2.destroyer();
            document.getElementById("PRE_TEST").value = "";
            document.getElementById("PRE_TEST2").value = "";
        }
    });
    QUnit.test("Check context", function (assert){
        expect(3);
        var ctx1 = CLD.findWidget(document.getElementById("PRE_TEST"), "AutoComplete")
        var ctx2 = CLD.findWidget(document.getElementById("PRE_TEST2"), "AutoComplete")
        assert.notDeepEqual(ctx1, ctx2);
        assert.deepEqual(ctl1, ctx1);
        assert.deepEqual(ctl2, ctx2);
    });


};


window.addEventListener("load", init, true);
</script>
<br/>
<br/>
<br/>
<input id="PRE_TEST"><input id="Submit" type="button" value="Submit">
<br/>
<br/>
<input id="PRE_TEST2">
<div id="qunit"></div>
